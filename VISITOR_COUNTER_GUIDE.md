# คู่มือการใช้งาน Visitor Counter ที่แก้ไขแล้ว

## ปัญหาที่ได้รับการแก้ไข

### 1. ตัวนับจำนวนคนเข้าชมเว็บไม่แสดงข้อมูล
**สาเหตุ:** API `hit.js` และ `counter.js` มี counter object แยกกัน ทำให้ข้อมูลไม่ sync กัน

**วิธีแก้ไข:** สร้าง shared storage (`utils/storage.js`) ที่ทั้งสอง API สามารถเข้าถึงข้อมูลเดียวกันได้

### 2. ไม่มีการลบจำนวนคนเข้าชม  
**สาเหตุ:** ไม่มี API endpoint สำหรับการรีเซ็ต counter และการล้างข้อมูลเก่า

**วิธีแก้ไข:** 
- เพิ่ม DELETE method ใน `/api/counter` สำหรับรีเซ็ตทั้งหมด
- เพิ่ม POST method สำหรับลบข้อมูลเฉพาะ
- สร้างระบบล้างข้อมูลเก่าอัตโนมัติ (เก็บแค่ 7 วัน และ 4 สัปดาห์)
- เพิ่มฟังก์ชัน admin ครบครัน

### 3. ข้อมูลเก็บไปเรื่อยๆ ไม่มีการจัดการ
**สาเหตุ:** ไม่มีการล้างข้อมูลเก่าและการคำนวณ total ใหม่

**วิธีแก้ไข:**
- ลบข้อมูลรายวันอัตโนมัติหลัง 7 วัน
- ลบข้อมูลรายสัปดาห์อัตโนมัติหลัง 4 สัปดาห์  
- คำนวณ total counter ใหม่เมื่อลบข้อมูล
- เรียก cleanOldData() ทุกครั้งที่มีการ hit และ get counter

## ไฟล์ที่ได้รับการแก้ไข

### 1. `utils/storage.js` (ไฟล์ใหม่)
- Shared storage สำหรับ counter data
- มีฟังก์ชันสำหรับจัดการ counter ครบครัน
- รองรับการทำความสะอาดข้อมูลเก่าอัตโนมัติ

### 2. `api/hit.js`
- ใช้ shared storage แทน local counter
- ข้อมูลจะ sync กับ `counter.js`

### 3. `api/counter.js`
- ใช้ shared storage แทน local counter
- เพิ่ม DELETE method สำหรับรีเซ็ต counter
- รองรับ CORS สำหรับ DELETE method

### 4. `index.html`
- ปรับปรุงฟังก์ชัน loadVisitorStats
- เพิ่มฟังก์ชัน admin ใน window object

## วิธีการใช้งาน

### การดูข้อมูล counter
ข้อมูลจะแสดงอัตโนมัติในส่วน navbar ของเว็บไซต์

### การรีเซ็ต counter (สำหรับ Admin)
1. เปิด Browser Console (F12)
2. พิมพ์คำสั่ง: `resetVisitorCounter()`
3. ยืนยันการรีเซ็ต

### การรีเฟรชข้อมูล counter
1. เปิด Browser Console (F12)  
2. พิมพ์คำสั่ง: `refreshVisitorStats()`

### การดูสถิติแบบละเอียด
1. เปิด Browser Console (F12)
2. พิมพ์คำสั่ง: `showDetailedStats()`
3. ดูข้อมูลใน Console และ Alert

### การลบข้อมูลเฉพาะวัน
1. เปิด Browser Console (F12)
2. พิมพ์คำสั่ง: `clearSpecificDay('2024-08-25')` หรือ `clearSpecificDay()` แล้วใส่วันที่
3. ยืนยันการลบ

### การบังคับล้างข้อมูลเก่า
1. เปิด Browser Console (F12)
2. พิมพ์คำสั่ง: `forceCleanup()`
3. ยืนยันการล้างข้อมูล

### API Endpoints

#### GET /api/counter
ดึงข้อมูลจำนวนผู้เข้าชม
```json
{
  "total": 150,
  "today": 5,
  "week": 25
}
```

#### GET /api/counter?stats=detailed
ดึงข้อมูลสถิติแบบละเอียด
```json
{
  "total": 150,
  "totalDays": 7,
  "totalWeeks": 4,
  "dailyData": {
    "2024-08-25": 5,
    "2024-08-24": 3
  },
  "weeklyData": {
    "2024-08-19": 25,
    "2024-08-12": 20
  }
}
```

#### POST /api/hit  
บันทึกการเข้าชม (เรียกอัตโนมัติเมื่อโหลดหน้าเว็บ)

#### DELETE /api/counter
รีเซ็ตตัวนับทั้งหมด
```json
{
  "message": "ตัวนับถูกรีเซ็ตเรียบร้อยแล้ว",
  "success": true
}
```

#### POST /api/counter
ลบข้อมูลเฉพาะหรือบังคับล้างข้อมูล

**ลบข้อมูลเฉพาะวัน:**
```json
{
  "action": "clearDay", 
  "date": "2024-08-25"
}
```

**ลบข้อมูลเฉพาะสัปดาห์:**
```json
{
  "action": "clearWeek", 
  "date": "2024-08-19"
}
```

**บังคับล้างข้อมูลเก่า:**
```json
{
  "action": "forceCleanup"
}
```

## การป้องกันการนับซ้ำ

- **วันนี้:** 1 IP address = 1 การเข้าชมต่อวัน
- **สัปดาห์นี้:** 1 IP address = 1 การเข้าชมต่อสัปดาห์  
- **รวมทั้งหมด:** นับสะสมจากการเข้าชมใหม่ของแต่ละวัน

## การจัดการข้อมูลเก่า

- ข้อมูลรายวันจะถูกลบอัตโนมัติหลังจาก **7 วัน**
- ข้อมูลรายสัปดาห์จะถูกลบอัตโนมัติหลังจาก **4 สัปดาห์**
- การลบข้อมูลเก่าทำงานอัตโนมัติทุกครั้งที่มีการเข้าชมและดูสถิติ
- เมื่อลบข้อมูลเก่า ระบบจะคำนวณ total counter ใหม่ให้ถูกต้อง
- สามารถบังคับล้างข้อมูลเก่าได้ด้วยฟังก์ชัน `forceCleanup()`

## ฟีเจอร์ใหม่

### 1. การลบข้อมูลเฉพาะ
- ลบข้อมูลเฉพาะวันที่ต้องการ
- ลบข้อมูลเฉพาะสัปดาห์ที่ต้องการ

### 2. สถิติแบบละเอียด
- ดูข้อมูลรายวันทั้งหมด
- ดูข้อมูลรายสัปดาห์ทั้งหมด
- นับจำนวนวันและสัปดาห์ที่มีข้อมูล

### 3. การล้างข้อมูลอัตโนมัติ
- ล้างข้อมูลเก่าทุกครั้งที่เรียก API
- คำนวณ total ใหม่เมื่อมีการลบข้อมูล
- แสดง log การลบข้อมูลใน console

### 4. ฟังก์ชัน Admin ครบครัน
- `resetVisitorCounter()` - รีเซ็ตทั้งหมด
- `showDetailedStats()` - ดูสถิติละเอียด  
- `clearSpecificDay(date)` - ลบข้อมูลเฉพาะวัน
- `forceCleanup()` - บังคับล้างข้อมูลเก่า
- `refreshVisitorStats()` - รีเฟรชข้อมูล

## หมายเหตุสำหรับการใช้งานจริง

ในการใช้งานจริงบน production ควรเปลี่ยนจาก in-memory storage ไปใช้:
- Vercel KV
- Redis
- Database (PostgreSQL, MongoDB, etc.)

เพื่อให้ข้อมูลไม่หายไปเมื่อ function restart
